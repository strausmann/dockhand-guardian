services:
  # Example application container to be monitored
  dockhand-app:
    image: nginx:alpine
    container_name: dockhand-app
    ports:
      - "8080:80"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - dockhand-net

  # Example database container to be monitored
  dockhand-database:
    image: postgres:15-alpine
    container_name: dockhand-database
    environment:
      POSTGRES_USER: dockhand
      POSTGRES_PASSWORD: dockhand_secret
      POSTGRES_DB: dockhand
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dockhand"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - dockhand-net

  # Guardian sidecar that monitors the containers
  guardian:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: dockhand-guardian
    restart: unless-stopped
    environment:
      # Containers to monitor (comma-separated)
      MONITORED_CONTAINERS: dockhand-app,dockhand-database

      # Time in seconds to wait before triggering recovery (default: 300)
      GRACE_SECONDS: 300

      # How often to check container health in seconds (default: 30)
      CHECK_INTERVAL: 30

      # Cooldown period in seconds after recovery (default: 600)
      COOLDOWN_SECONDS: 600

      # Directory containing docker-compose.yml (mounted as volume)
      STACK_DIR: /stack

      # Maintenance mode flag file name (default: .maintenance)
      MAINTENANCE_FILE: .maintenance

      # Optional HTTP health checks (format: container=url,container2=url2)
      # HTTP_CHECKS: dockhand-app=http://dockhand-app:80/health

      # Webhook notifications via Apprise (80+ services supported)
      # Single service:
      # WEBHOOK_URLS: discord://webhook_id/webhook_token
      # Multiple services (comma-separated):
      # WEBHOOK_URLS: discord://ID/TOKEN,msteams://A/B/C/
      # See: https://github.com/caronc/apprise/wiki

    volumes:
      # Mount Docker socket to communicate with Docker daemon
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Mount the directory containing docker-compose.yml for recovery
      - .:/stack:ro

    networks:
      - dockhand-net

    depends_on:
      - dockhand-app
      - dockhand-database

networks:
  dockhand-net:
    driver: bridge
